datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  role          UserRole  @default(USER)

  // Anonymous fields (visible only after mutual match)
  displayName   String?
  photos        Json?
  bio           String?
  age           Int?
  gender        String?
  interests     String[]
  dateOfBirth   DateTime?
  ageVerifiedAt DateTime?
  consents      Json?
  privacyNoticeVersion String?
  tosVersion    String?

  // Always private
  phone         String?   @unique
  email         String?   @unique
  tokenBalance  Int       @default(0)

  // Relations (ignore for now)
  sessionsAsA   Session[] @relation("UserASessions")
  sessionsAsB   Session[] @relation("UserBSessions")
  matchesAsA    Match[]   @relation("UserAMatches")
  matchesAsB    Match[]   @relation("UserBMatches")
  tokenTxs      TokenTransaction[]
  moderation    ModerationEvent[]
  appeals       ModerationAppeal[]
  refreshTokens RefreshToken[]
  messagesSent  Message[]
  reportsMade   ModerationReport[] @relation("ReportsMade")
  reportsReceived ModerationReport[] @relation("ReportsReceived")
  blocksMade    Block[]  @relation("BlocksMade")
  blocksReceived Block[] @relation("BlocksReceived")
  pushTokens    PushToken[]
}

model FeatureFlag {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  key         String   @unique
  enabled     Boolean  @default(false)
  variant     String?
  description String?
  metadata    Json?
}

model RefreshToken {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userId       String
  tokenHash    String   @unique
  familyId     String
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?
  userAgent    String?
  ipAddress    String?
  lastUsedAt   DateTime?
  sessionName  String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([familyId])
}

model Session {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userAId   String
  userBId   String
  region    String?
  queueKey  String?

  userA User @relation("UserASessions", fields: [userAId], references: [id])
  userB User @relation("UserBSessions", fields: [userBId], references: [id])

  @@index([queueKey])
  @@index([userAId])
  @@index([userBId])
}

model Match {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userAId   String
  userBId   String
  userARevealAcknowledgedAt DateTime?
  userBRevealAcknowledgedAt DateTime?

  userA User @relation("UserAMatches", fields: [userAId], references: [id])
  userB User @relation("UserBMatches", fields: [userBId], references: [id])
  messages Message[]

  @@unique([userAId, userBId])
  @@index([userAId])
  @@index([userBId])
}

model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  matchId   String
  senderId  String
  text      String

  match  Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  sender User  @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([matchId, createdAt])
  @@index([senderId])
}

model TokenTransaction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  type      TokenTransactionType
  amount    Int
  balanceAfter Int
  stripeSessionId String? @unique
  stripeEventId   String? @unique
  metadata  Json?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

enum TokenTransactionType {
  CREDIT
  DEBIT
}

model ModerationEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model ModerationReport {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  reporterId     String
  reportedUserId String
  reason         String
  details        String?
  status         String   @default("OPEN")

  reporter    User @relation("ReportsMade", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser User @relation("ReportsReceived", fields: [reportedUserId], references: [id], onDelete: Cascade)
  appeals     ModerationAppeal[]

  @@index([reporterId])
  @@index([reportedUserId])
  @@index([status])
}

model ModerationAppeal {
  id                 String   @id @default(cuid())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  userId             String
  moderationReportId String?
  actionType         String
  reason             String?
  status             String   @default("OPEN")
  resolution         String?
  resolvedAt         DateTime?
  resolverUserId     String?

  user   User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  report ModerationReport? @relation(fields: [moderationReportId], references: [id], onDelete: SetNull)

  @@index([userId, status])
  @@index([status, createdAt])
  @@index([moderationReportId])
}

model AnalyticsEvent {
  id                 String   @id @default(cuid())
  createdAt          DateTime @default(now())
  eventSchemaVersion Int
  eventId            String   @unique
  eventName          String
  occurredAt         DateTime
  receivedAt         DateTime @default(now())
  source             String
  platform           String
  appVersion         String?
  buildNumber        String?
  region             String?
  requestId          String?
  userId             String?
  sessionId          String?
  matchId            String?
  queueKey           String?
  properties         Json

  @@index([occurredAt])
  @@index([eventName, occurredAt])
  @@index([platform, occurredAt])
}

model AnalyticsIngestHourly {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  hourStart     DateTime
  eventName     String
  acceptedCount Int      @default(0)
  droppedCount  Int      @default(0)

  @@unique([hourStart, eventName])
  @@index([hourStart])
}

model TelemetryGateSnapshot {
  id                     String   @id @default(cuid())
  createdAt              DateTime @default(now())
  windowStart            DateTime
  windowEnd              DateTime
  waitP50Seconds         Float?
  waitP90Seconds         Float?
  abandonmentRate        Float?
  completionRate         Float?
  mutualMatchRate        Float?
  chatActivationRate     Float?
  severeIncidentPer10k   Float?
  appealOverturnRate     Float?
  severeActionLatencyP95 Float?
  stage0Status           String
  stage1Status           String
  stage2Status           String
  autoPauseTriggered     Boolean  @default(false)
  autoPauseReasons       Json?

  @@index([windowEnd])
}

model Block {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  blockerId String
  blockedId String
  liftedAt  DateTime?

  blocker     User @relation("BlocksMade", fields: [blockerId], references: [id], onDelete: Cascade)
  blockedUser User @relation("BlocksReceived", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId, liftedAt])
  @@index([blockedId, liftedAt])
}

model PushToken {
  id        String       @id @default(cuid())
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  userId    String
  token     String       @unique
  platform  PushPlatform
  deviceId  String?
  lastSeenAt DateTime    @default(now())
  revokedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt])
  @@index([platform, revokedAt])
}

enum PushPlatform {
  WEB
  IOS
  ANDROID
}

enum UserRole {
  USER
  ADMIN
}
